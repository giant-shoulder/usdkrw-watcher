# utils/signal_utils.py

from config import SIGNAL_WEIGHTS

def get_signal_direction(messages):
    """ë©”ì‹œì§€ ë‚´ í‚¤ì›Œë“œ ê¸°ë°˜ìœ¼ë¡œ buy/sell/conflict/neutral íŒë‹¨"""
    buy_keywords = {
        "í•˜ë‹¨", "í•˜ë½",        # ë°´ë“œ ì´íƒˆ â†’ ê³¼ë§¤ë„
        "ê³¨ë“ í¬ë¡œìŠ¤", "ê¸‰ë°˜ë“±", # ì¶”ì„¸ ì „í™˜ ìƒìŠ¹
        "ë°˜ì „", "ì €ì ", "ì´íƒˆ", "ì•½ì„¸"  # ì˜ˆìƒë³´ë‹¤ í•˜ë½ â†’ ì €ê°€ ë§¤ìˆ˜
    }

    sell_keywords = {
        "ìƒë‹¨", "ìƒìŠ¹",         # ë°´ë“œ ìƒë‹¨ ëŒíŒŒ â†’ ê³¼ì—´
        "ë°ë“œí¬ë¡œìŠ¤", "ê¸‰ë“±",   # ì¶”ì„¸ ì „í™˜ í•˜ë½ or ê³¼ì—´ ê¸‰ë“±
        "ê³ ì ", "ê³¼ì—´", "ëŒíŒŒ"   # ê³ ì  ë„ë‹¬ íŒë‹¨
    }

    def contains(msg, keywords):
        return any(kw in msg for kw in keywords)

    buy_score = sum(contains(msg, buy_keywords) for msg in messages if msg)
    sell_score = sum(contains(msg, sell_keywords) for msg in messages if msg)

    if buy_score > 0 and sell_score == 0:
        return "buy"
    elif sell_score > 0 and buy_score == 0:
        return "sell"
    elif buy_score > 0 and sell_score > 0:
        return "buy" if buy_score > sell_score else "sell" if sell_score > buy_score else "conflict"
    return "neutral"

def get_signal_score(active_signals: dict[str, str]) -> int:
    """
    í™œì„±í™”ëœ ì „ëžµì— ë”°ë¼ ì¢…í•© ì ìˆ˜ ê³„ì‚°.
    ê° ì „ëžµë³„ ê°€ì¤‘ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•˜ê³ , ìµœëŒ€ 100ì ìœ¼ë¡œ ì œí•œ.
    """
    score = 0
    for signal_name in active_signals:
        weight = SIGNAL_WEIGHTS.get(signal_name, 0)
        score += weight
    return min(score, 100)

def generate_combo_summary(score: int, matched: int, total: int, direction: str) -> str:
    """
    ì ìˆ˜ ë° ë°©í–¥ì„± ê¸°ë°˜ ì½¤ë³´ ì „ëžµ í—¤ë” ìƒì„±

    Args:
        score (int): ì‹ í˜¸ ì ìˆ˜ (0~100)
        matched (int): í™œì„±í™”ëœ ì „ëžµ ìˆ˜
        total (int): ì „ì²´ ì „ëžµ ìˆ˜
        direction (str): 'buy', 'sell', 'conflict', 'neutral'

    Returns:
        str: í…”ë ˆê·¸ëž¨ìš© í—¤ë” ë©”ì‹œì§€
    """
    ratio = matched / total if total else 0
    dir_text = {"buy": "ðŸŸ¢ ë§¤ìˆ˜", "sell": "ðŸ”´ ë§¤ë„", "conflict": "âš–ï¸ ì¤‘ë¦½", "neutral": "â„¹ï¸ ê´€ë§"}.get(direction, "â“ ë¯¸í™•ì •")

    # âœ… ë‹¨ì¼ ì „ëžµì¼ ê²½ìš°ëŠ” ë³„ë„ ë©”ì‹œì§€ ì²˜ë¦¬
    if matched == 1:
        if score >= 30:
            return (
                f"ðŸ“Œ *[ì£¼ìš” ì „ëžµ ê¸°ë°˜ í•´ì„ â€” {dir_text} ì‹œì‚¬]*\n"
                f"ðŸ’¬ í•˜ë‚˜ì˜ í•µì‹¬ ì „ëžµì—ì„œ ë°©í–¥ì„± ë‹¨ì„œê°€ í¬ì°©ë˜ì—ˆìŠµë‹ˆë‹¤."
            )
        else:
            return (
                f"ðŸ” *[ì°¸ê³ ìš© ì‹ í˜¸ â€” {dir_text} ì‹œì‚¬]*\n"
                f"ðŸ“‰ ì•½í•œ ì‹ í˜¸ë¡œ, ì‹œìž¥ íë¦„ ì°¸ê³  ìˆ˜ì¤€ìž…ë‹ˆë‹¤."
            )

    # âœ… 2ê°œ ì´ìƒ ì „ëžµì´ ì¼ì¹˜í•˜ëŠ” ê²½ìš° (ê¸°ì¡´ êµ¬ì¡° ìœ ì§€)
    if score >= 90 and ratio >= 0.75:
        return (
            f"ðŸ”¥ *[ê°•ë ¥í•œ {dir_text} ì‹ í˜¸ ê°ì§€]*\n"
            f"ðŸ’¡ ë‹¤ìˆ˜ ì „ëžµì´ ì¼ì¹˜í•˜ë©° ì‹œìž¥ ì›€ì§ìž„ì´ ëšœë ·í•©ë‹ˆë‹¤."
        )
    elif score >= 70:
        return (
            f"ðŸ§­ *[ì§„ìž… ê³ ë ¤ ë‹¨ê³„ â€” {dir_text} ì‹ í˜¸ ê°ì§€]*\n"
            f"ðŸ“ˆ ì—¬ëŸ¬ ì „ëžµì—ì„œ ì¼ì¹˜ëœ ë°©í–¥ì´ í¬ì°©ë˜ì—ˆìŠµë‹ˆë‹¤."
        )
    elif score >= 40:
        return (
            f"âš ï¸ *[ë¶ˆí™•ì‹¤í•œ ì‹œê·¸ë„ ê°ì§€]*\n"
            f"ðŸ“Œ ì¼ë¶€ ì „ëžµì€ {dir_text}ë¥¼ ì‹œì‚¬í•˜ì§€ë§Œ í•´ì„ì€ ì‹ ì¤‘ížˆ í•„ìš”í•©ë‹ˆë‹¤."
        )
    elif score >= 20:
        return (
            f"ðŸ” *[ì°¸ê³ ìš© ì‹ í˜¸ â€” {dir_text} ì‹œì‚¬]*\n"
            f"ðŸ“‰ ì•½í•œ ì‹ í˜¸ë¡œ, ì‹œìž¥ íë¦„ ì°¸ê³  ìˆ˜ì¤€ìž…ë‹ˆë‹¤."
        )
    else:
        return (
            f"ðŸš« *[ì§„ìž… ì‹ í˜¸ ë¶€ì¡± â€” ì „ëžµ í•´ì„ ë¯¸ì•½]*\n"
            f"{'ðŸ“ˆ ë§¤ìˆ˜ë¡œ' if direction == 'buy' else 'ðŸ“‰ ë§¤ë„ë¡œ'} í•´ì„í•  ê·¼ê±°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."
        )

def get_action_message(direction: str, score: int) -> str:
    if direction == "buy":
        if score < 30:
            return (
                "ðŸŸ¢ *ì €ì  ë°˜ë“± ê°€ëŠ¥ì„±ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.*\n"
                "ðŸ“‰ *ì‹œìž¥ì´ ê³¼ë§¤ë„ ìƒíƒœì¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.*\n"
                "ðŸ’¡ ì°¸ê³  ì§€í‘œë¡œ í™œìš©í•´ ë³´ì„¸ìš”."
            )
        elif score < 50:
            return (
                "ðŸŸ¢ *ì €ì  ë°˜ë“± ê°€ëŠ¥ì„±ì„ ì‹œì‚¬í•©ë‹ˆë‹¤.*\n"
                "ðŸ“‰ *ì‹œìž¥ì´ í•˜ë½ì„¸ë¥¼ ë³´ì´ëŠ” ê°€ìš´ë° ì¼ë¶€ ë°˜ë“± ì‹œê·¸ë„ì´ í¬ì°©ë˜ì—ˆìŠµë‹ˆë‹¤.*\n"
                "ðŸ’¡ ì§„ìž… íƒ€ì´ë°ìœ¼ë¡œ ë³´ê¸°ì—” ì´ë¥´ì§€ë§Œ, íë¦„ ê´€ì°°ì´ í•„ìš”í•©ë‹ˆë‹¤."
            )
        else:
            return (
                "ðŸŸ¢ *ë§¤ìˆ˜ ì§„ìž… íƒ€ì´ë°ìœ¼ë¡œ íŒë‹¨ë©ë‹ˆë‹¤.*\n"
                "ðŸ“‰ *ì‹œìž¥ì´ ê³¼ë„í•˜ê²Œ í•˜ë½í–ˆê±°ë‚˜, ë°˜ë“± ì‹ í˜¸ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.*\n"
                "ðŸ’¡ ì¶”ì„¸ ì „í™˜, ì €ì  ë°˜ë“± ê°€ëŠ¥ì„±ì„ ê³ ë ¤í•œ ì§„ìž… íƒ€ì´ë°ìž…ë‹ˆë‹¤."
            )

    elif direction == "sell":
        if score < 30:
            return (
                "ðŸ”´ *ê³ ì  ë„ë‹¬ ê°€ëŠ¥ì„±ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.*\n"
                "ðŸ“ˆ *ì‹œìž¥ ê³¼ì—´ êµ¬ê°„ì¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.*\n"
                "ðŸ’¡ ì°¸ê³  ì§€í‘œë¡œ í™œìš©í•´ ë³´ì„¸ìš”."
            )
        elif score < 50:
            return (
                "ðŸ”´ *ê³¼ì—´ ì‹ í˜¸ê°€ ì¼ë¶€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.*\n"
                "ðŸ“ˆ *ê³¼ê±° ê³ ì  íŒ¨í„´ê³¼ ìœ ì‚¬í•œ ì›€ì§ìž„ì´ í¬ì°©ë˜ì—ˆìœ¼ë‚˜ ì‹ ë¢°ë„ëŠ” ë‚®ìŠµë‹ˆë‹¤.*\n"
                "ðŸ’¡ ì¶”ì„¸ ë°˜ì „ ê°€ëŠ¥ì„±ì— ì£¼ì˜í•˜ì„¸ìš”."
            )
        else:
            return (
                "ðŸ”´ *ë§¤ë„ ê³ ë ¤ íƒ€ì´ë°ìœ¼ë¡œ íŒë‹¨ë©ë‹ˆë‹¤.*\n"
                "ðŸ“ˆ *ì‹œìž¥ì´ ê³¼ì—´ë˜ì—ˆê±°ë‚˜, í•˜ë½ ì „í™˜ ì‹ í˜¸ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.*\n"
                "ðŸ’¡ í”¼í¬ ë„ë‹¬ ë˜ëŠ” ê³ ì  ì°¨ìµ ì‹¤í˜„ êµ¬ê°„ì¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤."
            )

    elif direction == "conflict":
        return (
            "âš ï¸ *ì „ëžµ ê°„ ë°©í–¥ì„±ì´ ìƒì¶©ë©ë‹ˆë‹¤.*\n"
            "ðŸ’¡ ì„œë¡œ ë‹¤ë¥¸ ì‹œê·¸ë„ì´ ë™ì‹œì— ê°ì§€ë˜ì–´, ì„£ë¶€ë¥¸ ì§„ìž…ë³´ë‹¤ëŠ” ê´€ë§ì´ ê¶Œìž¥ë©ë‹ˆë‹¤."
        )

    else:
        return (
            "â„¹ï¸ *ëª…í™•í•œ ë°©í–¥ì„±ì´ ì—†ìŠµë‹ˆë‹¤.*\n"
            "ðŸ’¡ ì‹œìž¥ ìƒí™©ì„ ì¡°ê¸ˆ ë” ì§€ì¼œë³´ëŠ” ê²ƒì´ ì¢‹ê² ìŠµë‹ˆë‹¤."
        )